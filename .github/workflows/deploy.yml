name: CI/CD Pipeline

###
### [ 테스트 기준 ]
### push: main 브랜치 또는 태그 포함
### pull_request: main 브랜치가 타켓인 경우
###
### [ 배포 기준 ]
### PROD(메인): 태그 포함 push
### DEV(개발) : main 브랜치 push
###
on:
  push:
    branches: [ main ]
    tags: [ '**' ]
  pull_request:
    branches: [ main ]

jobs:

  # 1. 테스트
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Git Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run tests
        #run: npm test (https://github.com/orgs/community/discussions/152798#discussioncomment-13275218)
        run: npm run build

  # 2. 배포
  deploy:
    needs: test
    if: github.event_name == 'push' && github.repository.fork == false
    runs-on: ubuntu-latest

    environment:
      name: ${{ startsWith(github.ref, 'refs/tags/') && 'Production' || 'Development' }}
      url: ${{ vars.DEPLOYMENT_URL }}

    steps:
      - name: Checkout upstream repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Prepare deploy
        run: |
          git remote remove origin
          git remote add origin https://x-access-token:${{ secrets.DEPLOYMENT_SYNC_PAT }}@github.com/${{ secrets.DEPLOYMENT_FORK_USERNAME }}/whatshu-frontend.git
          git config --global user.email "${{ secrets.DEPLOYMENT_FORK_EMAIL }}"
          git config --global user.name "${{ secrets.DEPLOYMENT_FORK_USERNAME }}"
          git commit -m "chore: trigger deployment" --allow-empty

      - name: Sync Development Branch
        if: github.ref == 'refs/heads/main'
        run: |
          git push origin HEAD:refs/heads/development --force
          echo "Successfully synced to the development branch."

      - name: Sync Production Branch
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          git push origin HEAD:refs/heads/production --force
          echo "Successfully synced to the production branch."
